#cloud-config
# Whisper GPU Benchmark VM - Selectel
package_update: true
package_upgrade: true

packages:
  - git
  - curl
  - build-essential
  - ffmpeg

runcmd:
  # Install kernel headers for NVIDIA driver
  - apt-get install -y linux-headers-$(uname -r) || true

  # Skip CUDA install on GPU-optimized images (driver already present)
  # Only install if nvidia-smi doesn't work
  - |
    if ! nvidia-smi &>/dev/null; then
      echo "Installing NVIDIA drivers..."
      # Add NVIDIA package repository (Ubuntu 22.04)
      curl -fsSL https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb -o /tmp/cuda-keyring.deb
      dpkg -i /tmp/cuda-keyring.deb
      apt-get update
      apt-get install -y cuda-toolkit-12-4 nvidia-driver-550 || apt-get install -y nvidia-driver-550
      echo 'export PATH=/usr/local/cuda/bin:$PATH' >> /etc/profile.d/cuda.sh
      echo 'export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH' >> /etc/profile.d/cuda.sh
    else
      echo "NVIDIA driver already installed, skipping..."
    fi

  # Install uv (Python package manager)
  - curl -LsSf https://astral.sh/uv/install.sh | sh
  - echo 'source $HOME/.local/bin/env' >> /root/.bashrc
  - export PATH="/root/.local/bin:$PATH"

  # Clone project and install with Python 3.12 (for onnxruntime compatibility)
  - cd /root && git clone https://github.com/damir-manapov/hands-on-whisper.git
  - cd /root/hands-on-whisper && /root/.local/bin/uv python install 3.12 && /root/.local/bin/uv sync --python 3.12

  # Add CUDA libraries from pip packages to LD_LIBRARY_PATH
  - |
    SITE_PKGS="/root/hands-on-whisper/.venv/lib/python3.12/site-packages"
    echo "export LD_LIBRARY_PATH=\"$SITE_PKGS/nvidia/cudnn/lib:$SITE_PKGS/nvidia/cublas/lib:$SITE_PKGS/nvidia/cufft/lib:\$LD_LIBRARY_PATH\"" >> /root/.bashrc

  # Models are downloaded on-demand when first used
  # To pre-download specific models, SSH in and run:
  #   uv run python src/download_models.py --backend faster-whisper --models large-v3
  # Or download all (slow, ~15GB):
  #   uv run python src/download_models.py --backend all

  # Verify NVIDIA driver is working
  - nvidia-smi > /root/nvidia-smi.log 2>&1 || echo "NVIDIA driver not ready yet"

  # Create ready marker
  - touch /root/cloud-init-ready

final_message: "Whisper GPU benchmark VM ready after $UPTIME seconds"
